<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Paulo Jerônimo">
<title>Discounts Processor (Kafka Streams version)</title>
<link rel="stylesheet" href="./README.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./rouge-github.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Discounts Processor (Kafka Streams version)</h1>
<div class="details">
<span id="author" class="author">Paulo Jerônimo</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. Overview</a></li>
<li><a href="#processors-rules">2. Processors Rules</a>
<ul class="sectlevel2">
<li><a href="#processor-configuration">2.1. Processor Configuration</a></li>
<li><a href="#continuous-view-processor">2.2. Continuous View Processor</a>
<ul class="sectlevel3">
<li><a href="#rules">2.2.1. Rules</a></li>
<li><a href="#business-value">2.2.2. Business Value</a></li>
</ul>
</li>
<li><a href="#most-viewed-processor">2.3. Most Viewed Processor</a>
<ul class="sectlevel3">
<li><a href="#rules-2">2.3.1. Rules</a></li>
<li><a href="#business-value-2">2.3.2. Business Value</a></li>
<li><a href="#relationship-with-continuous-view-processor">2.3.3. Relationship with Continuous View Processor</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#discount-conditions">3. Discount Conditions</a>
<ul class="sectlevel2">
<li><a href="#continuous-view-discount">3.1. Continuous View Discount</a>
<ul class="sectlevel3">
<li><a href="#viewing-time-calculation">3.1.1. Viewing Time Calculation</a></li>
</ul>
</li>
<li><a href="#most-viewed-product-discount">3.2. Most Viewed Product Discount</a>
<ul class="sectlevel3">
<li><a href="#basic-rules">3.2.1. Basic Rules</a></li>
<li><a href="#detailed-specifications">3.2.2. Detailed Specifications</a>
<ul class="sectlevel4">
<li><a href="#time-window">Time Window</a></li>
<li><a href="#event-flow">Event Flow</a></li>
<li><a href="#view-counting">View Counting</a></li>
<li><a href="#discount-generation">Discount Generation</a></li>
<li><a href="#tiebreaker-rules">Tiebreaker Rules</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#event-examples">4. Event examples</a>
<ul class="sectlevel2">
<li><a href="#input-events">4.1. Input (in <code>snowplow-enriched-good</code> topic)</a></li>
<li><a href="#output-events">4.2. Output (in <code>shopper-discounts</code> topic)</a></li>
</ul>
</li>
<li><a href="#running-the-application">5. Running the application</a>
<ul class="sectlevel2">
<li><a href="#prerequisites">5.1. Prerequisites</a></li>
<li><a href="#version-information">5.2. Version Information</a></li>
<li><a href="#running-manually">5.3. Running manually</a>
<ul class="sectlevel3">
<li><a href="#starting-redpanda">5.3.1. Starting Redpanda</a></li>
<li><a href="#running-the-application-2">5.3.2. Running the application</a></li>
<li><a href="#generating-events">5.3.3. Generating events</a></li>
<li><a href="#verifying-discounts">5.3.4. Verifying discounts</a></li>
</ul>
</li>
<li><a href="#running-via-docker-compose">5.4. Running via Docker Compose</a></li>
</ul>
</li>
<li><a href="#testing-procedures">6. Testing procedures</a>
<ul class="sectlevel2">
<li><a href="#unit-tests">6.1. Unit tests</a></li>
<li><a href="#mock-tests">6.2. Mock Tests</a></li>
</ul>
</li>
<li><a href="#discount-processors">7. Discount processors</a></li>
<li><a href="#mostviewed-processor-testing-results-comparator">8. MostViewed Processor Testing Results Comparator</a></li>
<li><a href="#parameters-used-in-generating-test-events">9. Parameters used in generating test events</a></li>
<li><a href="#troubleshooting">10. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#common-issues">10.1. Common Issues</a></li>
<li><a href="#logs">10.2. Logs</a></li>
</ul>
</li>
<li><a href="#developer-guide">11. Developer Guide</a>
<ul class="sectlevel2">
<li><a href="#developer-tips">11.1. Developer Tips</a>
<ul class="sectlevel3">
<li><a href="#gradle-commands">11.1.1. Gradle Commands</a>
<ul class="sectlevel4">
<li><a href="#skipping-tests">Skipping Tests</a></li>
<li><a href="#code-formatting">Code Formatting</a></li>
<li><a href="#running-specific-tests">Running Specific Tests</a></li>
</ul>
</li>
<li><a href="#ide-configuration">11.1.2. IDE Configuration</a>
<ul class="sectlevel4">
<li><a href="#intellij-idea">IntelliJ IDEA</a></li>
<li><a href="#vs-code">VS Code</a></li>
</ul>
</li>
<li><a href="#documentation">11.1.3. Documentation</a>
<ul class="sectlevel4">
<li><a href="#readme-generation">README Generation</a></li>
</ul>
</li>
<li><a href="#docker-tips">11.1.4. Docker Tips</a>
<ul class="sectlevel4">
<li><a href="#clean-environment">Clean Environment</a></li>
<li><a href="#quick-redpanda-access">Quick Redpanda Access</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#troubleshooting-2">11.2. Troubleshooting</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph text-center">
<p><strong><a href="README.pdf">PDF version</a></strong><br>
<strong>Git commit: 307097e</strong></p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This project (<strong>Discounts Processor (Kafka Streams version)</strong>) is a Java/ <a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a> application that processes event data from <a href="https://www.redpanda.com/">Redpanda</a> and generates <a href="#output-events">discount events</a> based on some <a href="#discount-conditions">conditions</a>.
So, based on the <a href="#input-events">input events</a>, it analyzes if the user is able to get discounts.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph lead text-center">
<p><strong>&#8594; PROJECT STATUS: UNDER DEVELOPMENT &#8592;</strong></p>
</div>
<div class="paragraph">
<p>Status:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#continuous-view-discount-processor">Continuous View Discount Processor</a>: Working well.</p>
</li>
<li>
<p><a href="#most-viewed-product-discount-processor">Most Viewed Product Discount Processor</a>: Under development/ test.</p>
</li>
</ol>
</div>
</div>
</div>
<div id="main-project-relation" class="paragraph">
<p>This module can be treated almost<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> entirely independently of <a href="https://github.com/osodevops/dynamic-ecommerce-discounts-with-redpanda">the main project</a> that encompasses it. It is an alternative intended to produce the same result as the <a href="https://github.com/osodevops/dynamic-ecommerce-discounts-with-redpanda/blob/main/redpanda/connect.yaml">connect.yaml</a> file configured using <a href="https://www.redpanda.com/connect">Redpanda Connect</a>. In other words, it is a discount processor that works under the same <a href="#discount-conditions">rules</a>.</p>
</div>
<div class="paragraph">
<p>The tests in this module are <a href="#unit-tests">unit tests</a> and <a href="#integration-tests">integration tests</a>.
Some of them are written in <a href="https://kotlinlang.org/">Kotlin</a> following the <a href="https://kotest.io/docs/framework/testing-styles.html#behavior-spec">BehaviourSpec</a> provided by <a href="https://kotest.io/">Kotest</a> framework.</p>
</div>
<div class="paragraph">
<p>The <a href="#integration-tests">integration tests</a> developed are executed with the help of <a href="https://www.testcontainers.org/">TestContainers</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="processors-rules"><a class="anchor" href="#processors-rules"></a>2. Processors Rules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the rules and business logic implemented by the two discount processors.</p>
</div>
<div class="sect2">
<h3 id="processor-configuration"><a class="anchor" href="#processor-configuration"></a>2.1. Processor Configuration</h3>
<div class="paragraph">
<p>The <code>DiscountsProcessor</code> provides flexible configuration options for both processors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Both processors can be enabled simultaneously</p>
</li>
<li>
<p>Either processor can be disabled independently</p>
</li>
<li>
<p>At least one processor must be enabled for the system to function</p>
</li>
<li>
<p>Configuration is managed through the <code>ConfigurationManager</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This flexibility allows for different business scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running both processors together provides the most comprehensive discount strategy</p>
</li>
<li>
<p>Running only the <code>MostViewedProcessor</code> can be useful when focusing on product discovery behavior</p>
</li>
<li>
<p>Running only the <code>ContinuousViewProcessor</code> emphasizes deep product engagement</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When running only the <code>MostViewedProcessor</code>, it&#8217;s recommended to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adjust the <code>processor.continuous-view.min-pings-for-discount</code> property to a higher value</p>
</li>
<li>
<p>This ensures that discounts are only given for products with significant user engagement</p>
</li>
<li>
<p>Helps maintain the quality of the discount program while focusing on the most viewed products</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="continuous-view-processor"><a class="anchor" href="#continuous-view-processor"></a>2.2. Continuous View Processor</h3>
<div class="paragraph">
<p>The <code>ContinuousViewProcessor</code> implements the primary discount strategy, which rewards users for continuous engagement with a single product.</p>
</div>
<div class="sect3">
<h4 id="rules"><a class="anchor" href="#rules"></a>2.2.1. Rules</h4>
<div class="ulist">
<ul>
<li>
<p>A 10% discount is generated when a user views the same product continuously for 90 seconds</p>
</li>
<li>
<p>The viewing time is calculated as:</p>
</li>
<li>
<p>Initial viewing time (when <code>product_view</code> occurs)</p>
</li>
<li>
<p>10-second delay to first ping</p>
</li>
<li>
<p>Each subsequent <code>page_ping</code> adds 10 seconds</p>
</li>
<li>
<p>Only one discount per user per 5-minute window</p>
</li>
<li>
<p>Cooldown period of 5 minutes after receiving any discount</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="business-value"><a class="anchor" href="#business-value"></a>2.2.2. Business Value</h4>
<div class="paragraph">
<p>This processor encourages deep product engagement by rewarding users who spend significant time examining a single product. This behavior often indicates strong purchase intent and can lead to higher conversion rates.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="most-viewed-processor"><a class="anchor" href="#most-viewed-processor"></a>2.3. Most Viewed Processor</h3>
<div class="paragraph">
<p>The <code>MostViewedProcessor</code> serves as a fallback mechanism when the continuous view criteria aren&#8217;t met, but the user still shows significant interest in multiple products.</p>
</div>
<div class="sect3">
<h4 id="rules-2"><a class="anchor" href="#rules-2"></a>2.3.1. Rules</h4>
<div class="ulist">
<ul>
<li>
<p>A 10% discount is generated for the most viewed product within a 5-minute window</p>
</li>
<li>
<p>View counting:</p>
<div class="ulist">
<ul>
<li>
<p>Minimum threshold: 3 views within the window</p>
</li>
<li>
<p>Only <code>page_ping</code> events count towards view totals</p>
</li>
<li>
<p>View duration is calculated using <code>page_ping</code> timestamps</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tiebreaker rules:</p>
<div class="ulist">
<ul>
<li>
<p>Product with longest total viewing time wins</p>
</li>
<li>
<p>If still tied, most recently viewed product wins</p>
</li>
</ul>
</div>
</li>
<li>
<p>One discount per user per window</p>
</li>
<li>
<p>5-minute cooldown period after receiving any discount</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="business-value-2"><a class="anchor" href="#business-value-2"></a>2.3.2. Business Value</h4>
<div class="paragraph">
<p>This processor serves as a valuable fallback for several reasons:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It captures users who browse multiple products but don&#8217;t spend enough time on any single one to trigger the continuous view discount</p>
</li>
<li>
<p>It rewards product discovery behavior, encouraging users to explore the catalog</p>
</li>
<li>
<p>It provides a second chance for discounts when the primary continuous view strategy doesn&#8217;t apply</p>
</li>
<li>
<p>It helps maintain user engagement by offering alternative paths to discounts</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="relationship-with-continuous-view-processor"><a class="anchor" href="#relationship-with-continuous-view-processor"></a>2.3.3. Relationship with Continuous View Processor</h4>
<div class="paragraph">
<p>The <code>MostViewedProcessor</code> complements the <code>ContinuousViewProcessor</code> by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Providing an alternative discount path for different user behaviors</p>
</li>
<li>
<p>Ensuring users who show interest in multiple products can still receive discounts</p>
</li>
<li>
<p>Creating a more comprehensive discount strategy that covers various shopping patterns</p>
</li>
<li>
<p>Maintaining user engagement through multiple interaction patterns</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This dual-processor approach creates a more robust and flexible discount system that can accommodate different user behaviors while maintaining clear business rules and objectives.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discount-conditions"><a class="anchor" href="#discount-conditions"></a>3. Discount Conditions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="continuous-view-discount"><a class="anchor" href="#continuous-view-discount"></a>3.1. Continuous View Discount</h3>
<div class="paragraph">
<p>A single discount of 10% (within a 5-minute window) is generated when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A user views the same product continuously within a 90-second window.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="viewing-time-calculation"><a class="anchor" href="#viewing-time-calculation"></a>3.1.1. Viewing Time Calculation</h4>
<div class="paragraph">
<p>The total viewing time includes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initial viewing time: When a <code>product_view</code> event occurs, it starts the viewing session</p>
</li>
<li>
<p>Delay to first ping: A configured time (default: 10 seconds) between the <code>product_view</code> and the first <code>page_ping</code></p>
</li>
<li>
<p>Subsequent pings: Regular intervals between <code>page_ping</code> events (default: 10 seconds)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, to achieve a 90-second continuous view:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial <code>product_view</code> event</p>
</li>
<li>
<p>10 seconds delay to first ping</p>
</li>
<li>
<p>8 subsequent <code>page_ping</code> events at 10-second intervals</p>
</li>
<li>
<p>Total time = 10 (delay) + (8 × 10) = 90 seconds</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This means that with default settings (10-second ping interval and 10-second initial delay), only 8 <code>page_ping</code> events are needed to achieve a 90-second continuous view, instead of 9 pings that would be needed without considering the initial viewing time.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The formula to calculate the total viewing time is:
<code>total_time = delay_to_first_ping + (number_of_pings × ping_interval)</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="most-viewed-product-discount"><a class="anchor" href="#most-viewed-product-discount"></a>3.2. Most Viewed Product Discount</h3>
<div class="sect3">
<h4 id="basic-rules"><a class="anchor" href="#basic-rules"></a>3.2.1. Basic Rules</h4>
<div class="paragraph">
<p>For each user, a 10% discount is generated for their most viewed product within a fixed 5-minute window.</p>
</div>
</div>
<div class="sect3">
<h4 id="detailed-specifications"><a class="anchor" href="#detailed-specifications"></a>3.2.2. Detailed Specifications</h4>
<div class="sect4">
<h5 id="time-window"><a class="anchor" href="#time-window"></a>Time Window</h5>
<div class="ulist">
<ul>
<li>
<p>Fixed 5-minute windows (00:00-00:05, 00:05-00:10, etc.)</p>
</li>
<li>
<p>Discount evaluation occurs at the end of each window</p>
</li>
<li>
<p>Events are processed based on their <code>collector_tstamp</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="event-flow"><a class="anchor" href="#event-flow"></a>Event Flow</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>product_view</code> event initiates a viewing session</p>
</li>
<li>
<p>Subsequent <code>page_ping</code> events for that product are counted</p>
</li>
<li>
<p>Session continues until another <code>product_view</code> event occurs</p>
</li>
<li>
<p>Process repeats for the new product</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="view-counting"><a class="anchor" href="#view-counting"></a>View Counting</h5>
<div class="ulist">
<ul>
<li>
<p>Minimum threshold: 3 views within the window</p>
</li>
<li>
<p>Only <code>page_ping</code> events count towards view totals</p>
</li>
<li>
<p>View duration is calculated using <code>page_ping</code> timestamps</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="discount-generation"><a class="anchor" href="#discount-generation"></a>Discount Generation</h5>
<div class="ulist">
<ul>
<li>
<p>Scope: Per user</p>
</li>
<li>
<p>Generated at window end</p>
</li>
<li>
<p>One discount per user per window</p>
</li>
<li>
<p>Cooldown: 5-minute period per user after receiving any discount</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="tiebreaker-rules"><a class="anchor" href="#tiebreaker-rules"></a>Tiebreaker Rules</h5>
<div class="paragraph">
<p>If a user has multiple products with the same number of views:
1. Product with longest total viewing time wins
2. If still tied, first product viewed wins</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Example Timeline (for user "U1")</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Time</th>
<th class="tableblock halign-left valign-top">Event</th>
<th class="tableblock halign-left valign-top">Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:00:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window starts</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:00:10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>product_view</code> P1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start tracking P1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:00:15-00:45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 <code>page_ping</code> P1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1: 4 views</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:01:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>product_view</code> P2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start tracking P2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:01:05-01:50</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 <code>page_ping</code> P2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2: 6 views</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:02:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>product_view</code> P1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start tracking P1 again</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:02:05-02:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 <code>page_ping</code> P1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1: total 7 views</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:05:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window ends</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1 wins (7 views)</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="event-examples"><a class="anchor" href="#event-examples"></a>4. Event examples</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="input-events"><a class="anchor" href="#input-events"></a>4.1. Input (in <code>snowplow-enriched-good</code> topic)</h3>
<div class="paragraph">
<p><a id="product_view"></a> <code>product_view</code> event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"collector_tstamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-04-04T07:05:00.119Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product_view"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"product_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"product_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SP Flex Runner 2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"product_price"</span><span class="p">:</span><span class="w"> </span><span class="mf">42.99</span><span class="p">,</span><span class="w">
  </span><span class="nl">"webpage_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"page_5"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="page_ping"></a> <code>page_ping</code> event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"collector_tstamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-04-04T07:05:12.130Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"page_ping"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"webpage_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"page_5"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="output-events"><a class="anchor" href="#output-events"></a>4.2. Output (in <code>shopper-discounts</code> topic)</h3>
<div class="paragraph">
<p><code>discount</code> event examples:</p>
</div>
<div class="paragraph">
<p><a href="#continuous-view-discount">Continuous View Discount</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"product_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"discount"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"by_view_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"duration_in_seconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#most-viewed-product-discount">Most Viewed Product Discount</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"product_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"discount"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"by_number_of_views"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"views"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"duration_in_seconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-application"><a class="anchor" href="#running-the-application"></a>5. Running the application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="prerequisites"><a class="anchor" href="#prerequisites"></a>5.1. Prerequisites</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Bash</p>
</li>
<li>
<p>Java</p>
</li>
<li>
<p><a href="https://www.docker.com/">Docker</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="version-information"><a class="anchor" href="#version-information"></a>5.2. Version Information</h3>
<div class="paragraph">
<p>These were the versions used during development:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="nv">$BASH_VERSION</span>
<span class="go">5.2.21(1)-release

</span><span class="gp">$</span><span class="w"> </span>java <span class="nt">--version</span>
<span class="go">openjdk 21.0.6 2025-01-21 LTS
OpenJDK Runtime Environment Temurin-21.0.6+7 (build 21.0.6+7-LTS)
OpenJDK 64-Bit Server VM Temurin-21.0.6+7 (build 21.0.6+7-LTS, mixed mode, sharing)

</span><span class="gp">$</span><span class="w"> </span>docker <span class="nt">--version</span>
<span class="go">Docker version 27.3.1, build ce12230</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a> is fully supported by Java 21. See this page: <a href="https://kafka.apache.org/documentation/#java" class="bare">https://kafka.apache.org/documentation/#java</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="running-manually"><a class="anchor" href="#running-manually"></a>5.3. Running manually</h3>
<div class="sect3">
<h4 id="starting-redpanda"><a class="anchor" href="#starting-redpanda"></a>5.3.1. Starting Redpanda</h4>
<div id="redpanda-start" class="paragraph">
<p>First, you need to start Redpanda using <code>docker compose</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker compose -f compose.redpanda.yaml up -d # &lt;- same effect as ./redpanda.sh up</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you&#8217;re done, use this command to stop Redpanda and remove all data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker compose -f compose.redpanda.yaml down -v --remove-orphans # &lt;- same effect as ./redpanda.sh down</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-2"><a class="anchor" href="#running-the-application-2"></a>5.3.2. Running the application</h4>
<div class="paragraph">
<p>The application can be executed using the provided <a href="run.sh" class="bare">run.sh</a> script, which handles building and running the application:</p>
</div>
<div class="paragraph">
<p>Start the application with an existing JAR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./run.sh</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can force a rebuild before running the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./run.sh <span class="nt">--build</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>run.sh</code> script will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build the application if the JAR doesn&#8217;t exist or if <code>--build</code> is specified</p>
</li>
<li>
<p>Configure appropriate JVM options</p>
</li>
<li>
<p>Handle graceful shutdown on SIGTERM/SIGINT</p>
</li>
<li>
<p>Display colored status messages during execution</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The script automatically manages the application lifecycle and provides proper cleanup on shutdown.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="generating-events"><a class="anchor" href="#generating-events"></a>5.3.3. Generating events</h4>
<div class="paragraph">
<p>To generate events in order to trigger discounts, use <a href="https://github.com/osodevops/dynamic-ecommerce-discounts-with-redpanda/tree/main/scripts/user-behavior-simulator">the Simulator project</a>.
You can use it to generate events (containing <code>product_view</code> and <code>page_ping</code> events in JSONL format) and send them to Redpanda.</p>
</div>
<div class="paragraph">
<p>So, the file <a href="data-samples/long.jsonl" class="bare">data-samples/long.jsonl</a> is an example of such a file.
You can send the events in this file to the input topic using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-i</span> redpanda rpk topic produce snowplow-enriched-good &lt; <span class="se">\</span>
<span class="gp">  data-samples/long.jsonl #</span><span class="w"> </span>&lt;- same effect as ./redpanda.sh produce</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The command above is to produce test events for testing the <a href="#continuous-view-discount-processor">Continuous View Discount Processor</a>.
To test the <a href="#most-viewed-product-discount-processor">Most Viewed Product Discount Processor</a>, use the command <code>data_type=frequent ./redpanda.sh produce</code>.</p>
</li>
<li>
<p>Using the <code>tstamp-diff.sh</code> script (available in main project) you can verify that the time difference between the collector timestamps for the <code>page_ping</code> events in this file is greater than 90 seconds as per the rule. Therefore, these <code>page_ping</code> events on it should generate a discount event according to <a href="#continuous-view-discount">the rule</a>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="o">{</span>
<span class="go">  f=data-samples/long.jsonl
</span><span class="gp">  start=$</span><span class="o">(</span><span class="nb">sed</span> <span class="nt">-n</span> 2p <span class="nv">$f</span> | jq <span class="nt">-r</span> .collector_tstamp<span class="o">)</span>
<span class="gp">  end=$</span><span class="o">(</span><span class="nb">sed</span> <span class="nt">-n</span> 11p <span class="nv">$f</span> | jq <span class="nt">-r</span> .collector_tstamp<span class="o">)</span>
<span class="gp">  ../scripts/tstamp-diff.sh $</span>start <span class="nv">$end</span>
<span class="go">}
90.075</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="verifying-discounts"><a class="anchor" href="#verifying-discounts"></a>5.3.4. Verifying discounts</h4>
<div class="paragraph">
<p>To verify that discounts are being generated correctly, consume from the output topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> redpanda rpk topic consume shopper-discounts <span class="c"># &lt;- same effect as ./redpanda.sh consume</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see discount events in the output that match the expected patterns based on the input events.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also open the Redpanda console at <a href="http://localhost:8080" class="bare">http://localhost:8080</a> to observe each of the events produced in the shopper-discounts topic.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-via-docker-compose"><a class="anchor" href="#running-via-docker-compose"></a>5.4. Running via Docker Compose</h3>
<div class="paragraph">
<p>To run the application, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker compose up --build -d</pre>
</div>
</div>
<div class="paragraph">
<p>Watch the logs to ensure the application is running correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker compose logs discounts-processor -f</pre>
</div>
</div>
<div class="paragraph">
<p>Generate events as described in <a href="#generating-events">Generating events</a>.</p>
</div>
<div class="paragraph">
<p>Verify discounts as described in <a href="#verifying-discounts">Verifying discounts</a>.</p>
</div>
<div class="paragraph">
<p>To stop the application and remove the containers, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker compose down -v --remove-orphans</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-procedures"><a class="anchor" href="#testing-procedures"></a>6. Testing procedures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="unit-tests"><a class="anchor" href="#unit-tests"></a>6.1. Unit tests</h3>
<div class="paragraph">
<p>Unit tests verify the core business logic of the discount processors without external dependencies.</p>
</div>
<div class="paragraph">
<p>To run all unit and mock tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew <span class="nb">test</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since all tests are mocked, there is no need to start Redpanda.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mock-tests"><a class="anchor" href="#mock-tests"></a>6.2. Mock Tests</h3>
<div class="paragraph">
<p>These are the two mock tests created for the <a href="#discount-processors">discount processors</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a id="continuous-view-discount-mock-test"></a> <a href="src/test/kotlin/com/example/processor/ContinuousViewProcessorTest.kt" class="bare">src/test/kotlin/com/example/processor/ContinuousViewProcessorTest.kt</a>::</p>
</li>
<li>
<p><a id="most-viewed-product-discount-mock-test"></a> <a href="src/test/kotlin/com/example/processor/MostViewedProcessorTest.kt" class="bare">src/test/kotlin/com/example/processor/MostViewedProcessorTest.kt</a>::</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To run a specific test class (e.g., <a href="src/test/kotlin/com/example/serialization/DiscountEventSerdeTest.kt">DiscountEventSerdeTest</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew <span class="nb">test</span> <span class="nt">--tests</span> <span class="s2">"com.example.serialization.DiscountEventSerdeTest"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run a mocked test for one of the two <a href="#discount-processors">discount processors</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew <span class="nb">test</span> <span class="nt">--tests</span> <span class="s2">"com.example.processor.MostViewedProcessorTest"</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discount-processors"><a class="anchor" href="#discount-processors"></a>7. Discount processors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This project contains two discount processors:</p>
</div>
<div id="continuous-view-discount-processor" class="dlist">
<dl>
<dt class="hdlist1"><a href="src/main/java/com/example/processor/ContinuousViewProcessor.java" class="bare">src/main/java/com/example/processor/ContinuousViewProcessor.java</a></dt>
<dd>
<p>Cover all the rules for the <a href="#continuous-view-discount">Continuous View Discount</a>.<br>
Test code: <a href="#continuous-view-discount-mock-test">ContinuousViewProcessorTest</a></p>
</dd>
</dl>
</div>
<div id="most-viewed-product-discount-processor" class="dlist">
<dl>
<dt class="hdlist1"><a href="src/main/java/com/example/processor/MostViewedProcessor.java" class="bare">src/main/java/com/example/processor/MostViewedProcessor.java</a></dt>
<dd>
<p>Cover all the rules for the <a href="#most-viewed-product-discount">Most Viewed Product Discount</a>.<br>
Test code: <a href="#most-viewed-product-discount-mock-test">MostViewedProcessorTest</a></p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="mostviewed-processor-testing-results-comparator"><a class="anchor" href="#mostviewed-processor-testing-results-comparator"></a>8. MostViewed Processor Testing Results Comparator</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ ./scripts/MostViewed.summary.compare.sh # &lt;- it will compare the results where testName=MostViewedSingleViewPerProduct

$ testName=MostViewedMultipleViewsPerProduct ./scripts/MostViewed.summary.compare.sh</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="parameters-used-in-generating-test-events"><a class="anchor" href="#parameters-used-in-generating-test-events"></a>9. Parameters used in generating test events</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ ./e2e/run.sh -t MostViewedMultipleViewsPerProduct -j --maxProducts 5 --maxPings 4</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>10. Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="common-issues"><a class="anchor" href="#common-issues"></a>10.1. Common Issues</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Connection issues</strong>: Verify that you <a href="#redpanda-start">started Redpanda</a>.</p>
</li>
<li>
<p><strong>No discounts generated</strong>: Ensure that enough events are being sent to trigger the <a href="#discount-conditions">discount conditions</a>.</p>
</li>
<li>
<p><strong>Serialization errors</strong>: Check that the event format matches <a href="#event-examples">the expected schema</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logs"><a class="anchor" href="#logs"></a>10.2. Logs</h3>
<div class="paragraph">
<p>Application logs can be configured in two files depending on the environment (main or test):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="src/main/resources/logback.xml">logback.xml</a></p>
</li>
<li>
<p><a href="src/test/resources/logback-test.xml">logback-test.xml</a></p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developer-guide"><a class="anchor" href="#developer-guide"></a>11. Developer Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="developer-tips"><a class="anchor" href="#developer-tips"></a>11.1. Developer Tips</h3>
<div class="sect3">
<h4 id="gradle-commands"><a class="anchor" href="#gradle-commands"></a>11.1.1. Gradle Commands</h4>
<div class="sect4">
<h5 id="skipping-tests"><a class="anchor" href="#skipping-tests"></a>Skipping Tests</h5>
<div class="paragraph">
<p>To skip test execution during build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew build <span class="nt">-x</span> <span class="nb">test</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="code-formatting"><a class="anchor" href="#code-formatting"></a>Code Formatting</h5>
<div class="paragraph">
<p>The project uses Spotless for code formatting. Common commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew spotlessCheck    <span class="c"># Check code formatting</span>
<span class="gp">$</span><span class="w"> </span>./gradlew spotlessApply    <span class="c"># Apply code formatting</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To automatically format code before each build, the project already includes <code>spotlessApply</code> as a build dependency.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="running-specific-tests"><a class="anchor" href="#running-specific-tests"></a>Running Specific Tests</h5>
<div class="paragraph">
<p>To run a specific test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew <span class="nb">test</span> <span class="nt">--tests</span> <span class="s2">"com.example.processor.MostViewedProcessorTest"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run only integration tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./gradlew integrationTest</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ide-configuration"><a class="anchor" href="#ide-configuration"></a>11.1.2. IDE Configuration</h4>
<div class="sect4">
<h5 id="intellij-idea"><a class="anchor" href="#intellij-idea"></a>IntelliJ IDEA</h5>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect4">
<h5 id="vs-code"><a class="anchor" href="#vs-code"></a>VS Code</h5>
<div class="ulist">
<ul>
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items/?itemName=EditorConfig.EditorConfig">"EditorConfig"</a></p>
<div class="ulist">
<ul>
<li>
<p>Configure "Editor: Format On Save" setting</p>
</li>
</ul>
</div>
</li>
<li>
<p>Install <a href="https://code.visualstudio.com/docs/java/extensions">"Java extensions for Visual Studio Code"</a></p>
<div class="ulist">
<ul>
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items/?itemName=SonarSource.sonarlint-vscode">"SonarQubei for IDE"</a></p>
</li>
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-gradle">"Gradle for Java"</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items/?itemName=mathiasfrohlich.Kotlin">"Kotlin Language"</a></p>
</li>
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items/?itemName=asciidoctor.asciidoctor-vscode">"AsciiDoc"</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="documentation"><a class="anchor" href="#documentation"></a>11.1.3. Documentation</h4>
<div class="sect4">
<h5 id="readme-generation"><a class="anchor" href="#readme-generation"></a>README Generation</h5>
<div class="paragraph">
<p>To rebuild the documentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./README.sh    <span class="c"># Generates README.html and updates other formats</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="docker-tips"><a class="anchor" href="#docker-tips"></a>11.1.4. Docker Tips</h4>
<div class="sect4">
<h5 id="clean-environment"><a class="anchor" href="#clean-environment"></a>Clean Environment</h5>
<div class="paragraph">
<p>To completely clean up Docker resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>docker compose down <span class="nt">-v</span> <span class="nt">--remove-orphans</span>
<span class="gp">$</span><span class="w"> </span>docker system prune <span class="nt">-f</span>    <span class="c"># Remove unused containers/images</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="quick-redpanda-access"><a class="anchor" href="#quick-redpanda-access"></a>Quick Redpanda Access</h5>
<div class="paragraph">
<p>The project includes convenient scripts for Redpanda operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./redpanda.sh up      <span class="c"># Start Redpanda</span>
<span class="gp">$</span><span class="w"> </span>./redpanda.sh down    <span class="c"># Stop Redpanda</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-2"><a class="anchor" href="#troubleshooting-2"></a>11.2. Troubleshooting</h3>
<div class="paragraph">
<p>Sometimes, you may need to clean up Java processss to start fresh.
If you have strange issues while testing the application, like in the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>run
<span class="go">Starting Discounts Processor...
Console output will be logged to: private/logs/run.log
10:08:18.621 Loading configuration from application.properties...
10:08:18.623 Configuration loaded:
10:08:18.626   Enabled processors: ContinuousView
10:08:18.628   Continuous view implementation: 2
10:08:18.628   Bootstrap servers: localhost:19092
10:08:18.628   Input topic: snowplow-enriched-good
10:08:18.628   Output topic: shopper-discounts
10:08:18.628   Group ID: discounts-processor
10:08:18.628   Auto offset reset: earliest
10:08:18.629   Window duration: 300s
10:08:18.629   Ping interval: 10s
10:08:18.629   Minimum pings: 8
10:08:18.629   Discount rate: 0.1
10:08:18.630 Initializing Discounts Processor...
10:08:18.739 Configuring ContinuousViewProcessor (implementation 2)...
Exception in thread "main" org.apache.kafka.streams.errors.StreamsException: Unable to initialize state, this can happen if multiple instances of Kafka Streams are running in the same state directory (current state directory is [/tmp/kafka-streams/discounts-processor]
        at org.apache.kafka.streams.processor.internals.StateDirectory.initializeProcessId(StateDirectory.java:191)
</span><span class="gp">        at org.apache.kafka.streams.KafkaStreams.&lt;init&gt;</span><span class="o">(</span>KafkaStreams.java:879<span class="o">)</span>
<span class="gp">        at org.apache.kafka.streams.KafkaStreams.&lt;init&gt;</span><span class="o">(</span>KafkaStreams.java:862<span class="o">)</span>
<span class="gp">        at org.apache.kafka.streams.KafkaStreams.&lt;init&gt;</span><span class="o">(</span>KafkaStreams.java:832<span class="o">)</span>
<span class="gp">        at org.apache.kafka.streams.KafkaStreams.&lt;init&gt;</span><span class="o">(</span>KafkaStreams.java:744<span class="o">)</span>
<span class="go">        at com.example.DiscountsProcessor.start(DiscountsProcessor.java:160)
        at com.example.DiscountsProcessor.main(DiscountsProcessor.java:184)
Application terminated successfully</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run these commands to clean up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>pkill java
<span class="gp">$</span><span class="w"> </span><span class="nb">rm</span> <span class="nt">-rf</span> /tmp/kafka-streams/discounts-processor/</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. It only relies on scripts that generate documentation.
</div>
</div>
</body>
</html>